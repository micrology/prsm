<!DOCTYPE html>
<html lang="en">
	<head>
		<title>PRSM: VR</title>
		<meta
			name="Description"
			content="PRSM enables groups of people, each using their own computer (or tablet) 
		to collaborate in the drawing of a map. They may be sitting around a table, discussing the map as it is 
		created face to face, or working remotely, using video conferencing or the chat feature that is built 
		into the app. Everyone can participate because every edit (creating nodes and links, arranging them 
		and so on) is broadcast to all the other participants as the changes are made (just as Google Docs 
		does for text, for example). When you start PRSM in your browser, a 'room' is created for you in which 
		to draw your network. You can add other users to this room to share the work. Only those with access 
		to the room can see what is being created."
		/>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no"
		/>
		<link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png" />
		<link rel="shortcut icon" href="../icons/favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />

		<script src="../node_modules/aframe/dist/aframe-v1.3.0.min.js"></script>
		<script src="../node_modules/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script>
		<script src="../node_modules/aframe-look-at-component/dist/aframe-look-at-component.min.js"></script>
		<script src="../node_modules/aframe-extras/dist/aframe-extras.controls.min.js"></script>
		<script src="../node_modules/aframe-forcegraph-component/dist/aframe-forcegraph-component.min.js"></script>
		<script src="../js/vr.js" type="module"></script>
		<script>
			// display a label in front of each node when pointer hits it
			AFRAME.registerComponent('node-hover', {
				schema: {
					label: {type: 'string', default: 'My label'},
					tipColor: {type: 'color', default: 'black'},
				},

				init: function () {
					const data = this.data
					const el = this.el
					el.addEventListener('mouseenter', function () {
						let tooltip = document.createElement('a-entity')
						tooltip.id = 'tooltip'
						tooltip.setAttribute('text', {
							value: data.label,
							color: data.tipColor,
							width: 2,
							align: 'center',
						})
						tooltip.setAttribute('scale', {x: 20, y: 20, z: 20})
						const mesh = el.getObject3D('mesh')
						const bsphere = mesh.geometry.boundingSphere
						const rig = document.createElement('a-entity')
						rig.id = 'rig'
						rig.setAttribute('look-at', '[camera]')
						el.appendChild(rig)
						tooltip.setAttribute('position', {x: 0, y: 0, z: bsphere.radius})
						rig.appendChild(tooltip)
					})
					el.addEventListener('mouseleave', function () {
						let rig = el.querySelector('#rig')
						if (rig) el.removeChild(rig)
					})
				},
			})
			// draw a sphere around each node, to make it easy to point to them with the ray caster
			AFRAME.registerComponent('network', {
				schema: {},
				dependencies: ['forcegraph'],
				init: function () {
					this.spheres = new Map()
				},
				tick: function (time, timeDelta) {
					document
						.querySelector('[forcegraph]')
						.components.forcegraph.forceGraph.children.forEach((child) => {
							if (child.type == 'Mesh' && child.__data.id) {
								let sphereEl
								if (this.spheres.get(child.__data.id)) {
									sphereEl = this.spheres.get(child.__data.id)
									sphereEl.setAttribute('position', child.position)
								} else {
									sphereEl = document.createElement('a-sphere')
									sphereEl.classList.add('node')
									sphereEl.id = child.__data.id
									this.spheres.set(child.__data.id, sphereEl)
									sphereEl.setAttribute('position', child.position)
									sphereEl.setAttribute('radius', child.geometry.parameters.radius + 0.1)
									let childColor = child.__data.color
									sphereEl.setAttribute('color', childColor ? childColor : 'white')
									sphereEl.setAttribute('node-hover', {label: child.__data.label})
									this.el.appendChild(sphereEl)
								}
							}
						})
				},
			})
		</script>
	</head>
	<body>
		<a-scene>
			<a-assets>
				<img
					id="skyTexture"
					src="../img/Solarsystemscope_texture_8k_earth_nightmap.jpeg"
					crossorigin="anonymous"
				/>
				<img id="info" src="../img/info.png" crossorigin="anonymous" />
			</a-assets>
			<a-entity
				id="info"
				position="3 2 -2"
				text="width: 2; lineHeight: 50; letterSpacing: 5; color: white; value: 
				Use the right or left hand controller to point to Factors and show their labels.\n
				Use the right hand thumb stick to go forwards, back, left or right relative to the direction in which you are looking.\n
				Press and release the left hand trigger to teleport to another point on the landing plane. Use the left thumbstick to set the direction to go."
			></a-entity>
			<!-- force graph -->
			<a-entity id="fg"></a-entity>
			<!-- camera -->
			<a-entity id="cameraRig" movement-controls="fly: true; speed: 0.7">
				<a-camera id="camera" look-controls="pointerLockEnabled: true"></a-camera>
				<a-entity
					id="left-hand"
					laser-controls="hand: left"
					raycaster="showLine: true; lineColor: white; objects: .collidable, .node"
					blink-controls="cameraRig: #cameraRig; teleportOrigin: #camera; button: trigger; snapTurn: false; collisionEntities: #ground"
				></a-entity>
				<a-entity laser-controls="hand: right" raycaster="objects: .collidable, .node"></a-entity>
			</a-entity>
			<!-- ground  -->
			<a-plane
			id="ground"
				material="color: green; opacity: 0.5; transparent: true; side: double"
				rotation="-90 0 0"
				width="500"
				height="500"
			></a-plane>
			<!-- centre point and axes -->
			<a-entity id="origin">
				<a-sphere color="lightgray" position="0 0 0" radius="0.05"></a-sphere>
				<a-entity line="start: -500 0 0; end: 500 0 0; color: red"></a-entity>
				<a-entity line="start: 0 -500 0; end: 0 500 0; color: green"></a-entity>
				<a-entity line="start: 0 0 -500; end: 0 0 500; color: blue"></a-entity>
			</a-entity>
			<!-- sky -->
			<a-sky src="#skyTexture"></a-sky>
		</a-scene>
	</body>
</html>
