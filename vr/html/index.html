<!DOCTYPE html>
<html>
	<head>
		<title>A-Frame Experiments</title>
		<meta name="description" content="A-Frame Experiments" />
		<style>
			.label {
				z-index: 20000;
				position: absolute;
				left: 0;
				top: 0;
				user-select: none;
				color: white;
			}
			/* #labels {
				width: 100px;
				height: 100px;
				background-color: yellow;
				z-index: 20;
				z-index: 1000;
				position: absolute;
				left: 0;
				top: 0;
			} */
		</style>
		<script src="../node_modules/aframe/dist/aframe-v1.3.0.min.js"></script>
		<script src="../node_modules/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script>
		<script src="../node_modules/aframe-look-at-component/dist/aframe-look-at-component.min.js"></script>
		<script src="../node_modules/aframe-extras/dist/aframe-extras.controls.min.js"></script>
		<script src="../node_modules/aframe-forcegraph-component/dist/aframe-forcegraph-component.min.js"></script>
		<script>
			AFRAME.registerComponent('click', {
				schema: {},

				init: function () {
					let el = this.el
					this.el.addEventListener('click', function () {
						el.object3D.rotateZ(1.1)
						el.object3D.rotateY(1.1)
					})
				},
			})

			AFRAME.registerComponent('hover', {
				schema: {
					color: {default: 'red'},
					text: {default: 'text'},
					tipColor: {default: 'yellow'},
				},

				init: function () {
					var data = this.data
					var el = this.el // <a-box>
					var defaultColor = el.getAttribute('material').color

					el.addEventListener('mouseenter', function () {
						el.setAttribute('color', data.color)
						let tooltip = document.createElement('a-entity')
						tooltip.id = 'tooltip'
						tooltip.setAttribute('text', {
							value: data.text,
							color: data.tipColor,
							width: 2,
							anchor: 'center',
							align: 'center',
						})
						tooltip.setAttribute('scale', {x: 2, y: 2, z: 2})
						const mesh = el.getObject3D('mesh')
						// the timeout is an ugly hack,
						// the bounding sphere isn't set yet
						//            setTimeout(evt => {
						const bsphere = mesh.geometry.boundingSphere
						const sphericalrig = document.createElement('a-entity')
						sphericalrig.id = 'sphericalrig'
						sphericalrig.setAttribute('look-at', '[camera]')
						//						sphericalrig.setAttribute('visible', true)
						el.appendChild(sphericalrig)
						tooltip.setAttribute('position', {x: 0, y: 0, z: bsphere.radius})
						sphericalrig.appendChild(tooltip)
						console.log(tooltip)
						//           }, 150)
					})
					el.addEventListener('mouseleave', function () {
						el.setAttribute('color', defaultColor)
						let sphericalrig = el.querySelector('#sphericalrig')
						if (sphericalrig) el.removeChild(sphericalrig)
					})
				},
			})
			AFRAME.registerComponent('node-hover', {
				schema: {
					text: {type: 'string', default: 'My label'},
					tipColor: {type: 'color', default: 'yellow'},
				},

				init: function () {
					const data = this.data
					const el = this.el
					el.addEventListener('mouseenter', function () {
						let tooltip = document.createElement('a-entity')
						tooltip.id = 'tooltip'
						tooltip.setAttribute('text', {
							value: data.text,
							color: data.tipColor,
							width: 2,
							align: 'center',
						})
						tooltip.setAttribute('scale', {x: 20, y: 20, z: 20})
						const mesh = el.getObject3D('mesh')
						const bsphere = mesh.geometry.boundingSphere
						const rig = document.createElement('a-entity')
						rig.id = 'rig'
						rig.setAttribute('look-at', '[camera]')
						el.appendChild(rig)
						tooltip.setAttribute('position', {x: 0, y: 0, z: bsphere.radius})
						rig.appendChild(tooltip)
					})
					el.addEventListener('mouseleave', function () {
						let rig = el.querySelector('#rig')
						if (rig) el.removeChild(rig)
					})
				},
			})
			AFRAME.registerComponent('network', {
				schema: {},
				dependencies: ['forcegraph'],
				init: function () {
					this.spheres = new Map()
				},
				tick: function (time, timeDelta) {
					document
						.querySelector('[forcegraph]')
						.components.forcegraph.forceGraph.children.forEach((child) => {
							if (child.type == 'Mesh') {
								let sphereEl
								if (this.spheres.get(child.__data.id)) {
									sphereEl = this.spheres.get(child.__data.id)
									sphereEl.setAttribute('position', child.position)
								} else {
									sphereEl = document.createElement('a-sphere')
									sphereEl.classList.add('node')
									sphereEl.id = child.__data.id
									this.spheres.set(child.__data.id, sphereEl)
									sphereEl.setAttribute('position', child.position)
									sphereEl.setAttribute('radius', child.geometry.parameters.radius + 0.1)
									sphereEl.setAttribute('color', child.__data.color)
									sphereEl.setAttribute('node-hover', {text: child.__data.id})
									this.el.appendChild(sphereEl)
								}
							}
						})
				},
			})
		</script>
	</head>
	<body>
		<div id="labels"></div>
		<a-scene>
			<a-assets>
				<img
					id="skyTexture"
					src="../img/Solarsystemscope_texture_8k_earth_nightmap.jpeg"
					crossorigin="anonymous"
				/>
				<img id="groundTexture" src="../img/floor.jpeg" crossorigin="anonymous" />
				<img id="controls" src="../img/controls.png" crossorigin="anonymous" />
			</a-assets>
			<a-box
				class="collidable"
				color="red"
				position="2 2 -5"
				rotation="0 0 0"
				scale="1 1 1"
				click
				hover="color: blue; text: red cube"
			></a-box>
			<a-box
				class="collidable"
				color="green"
				position="-2 2 -5"
				rotation="0 0 0"
				scale="1 1 1"
				click
				hover="color: blue; text: green cube"
			></a-box>
			<!-- billboard -->
<!--  			<a-entity position="3 2 -2" rotation="0 -90 0" width="2">  -->
				<!-- <a-box color="grey" width="2" height="2.5" depth="0.02" position="3 2 -2" rotation="0 -90 0"></a-box>
				<a-text
					id="billboard-text"
					value="This is some instructional text and will spread over several lines I hope"
					color="white"
					width="2"
					position="3 2 -2" 
					rotation="0 -90 0"
				></a-text> -->
<!--  			</a-entity> 
 -->			<!-- 		<a-entity cursor="rayOrigin: mouse; mouseCursorStylesEnabled: true;" raycaster="objects: [forcegraph];"></a-entity>
			-->
			<a-box color="grey" width="2.5" height="2.5" depth="0.02" position="3 2 -2" rotation="0 -90 0"
			src="#controls"></a-box>
			<!-- <a-entity
  geometry="primitive: plane; width: 1; height: auto;"
  material="color: grey"
  text="value: This text will be 1 units wide.This text will be 1 units wideThis text will be 1 units wideThis text will be 1 units wide; width:0.8"
  position="2.95 2 -2" 
  rotation="0 -90 0"></a-entity> -->
			<a-entity
				forcegraph="
			json-url: ../img/miserables.json; 
			node-auto-color-by: group;
			node-resolution: 16
        	link-directional-arrow-length: 1.5;
        	link-directional-arrow-rel-pos: 1;
			on-node-hover: node => showLabel2(node);
			on-node-click: node => console.log(node);
			"
				network
			></a-entity>

			<a-entity
				id="Hello"
				text="value: Hello, A-Frame; color: #FAFAFA; width: 5; anchor: align"
				position="-0.9 0.2 -3"
				scale="1.5 1.5 1.5"
			></a-entity>
			<a-entity id="cameraRig" movement-controls="fly: true">
				<a-camera id="camera" look-controls="pointerLockEnabled: true">
					<a-cursor color="#FF0000" raycaster="objects: .collidable, .node"></a-cursor>
				</a-camera>
				<a-entity
					id="left-hand"
					oculus-touch-controls="hand: left"
					blink-controls="cameraRig: #cameraRig; teleportOrigin: #camera; button: trigger; snapTurn: false; defaultPlaneSize: 500"
				></a-entity>
				<a-entity laser-controls="hand: right" raycaster="objects: .collidable, .node"></a-entity>
			</a-entity>
			<a-plane src="#groundTexture" rotation="-90 0 0" width="5" height="5" repeat="10 10"></a-plane>
			<a-entity id="origin">
				<a-sphere color="lightgray" radius="0.05"></a-sphere>
				<a-entity line="start: -500 0 0; end: 500 0 0; color: red"></a-entity>
				<a-entity line="start: 0 -500 0; end: 0 500 0; color: green"></a-entity>
				<a-entity line="start: 0 0 -500; end: 0 0 500; color: blue"></a-entity>
			</a-entity>
			<a-sky src="#skyTexture"></a-sky>
		</a-scene>
		<script>
			function showLabel(node) {
				console.log(node)
				// if no node, remove label (for safety, remove all)
				if (node === null) {
					document.querySelectorAll('.label').forEach((el) => el.remove())
					return
				}
				const labels = document.querySelector('#labels')
				const labelEl = document.createElement('p')
				labelEl.classList.add('label')
				labelEl.innerHTML = node.id
				labels.appendChild(labelEl)
				// position of node
				const tmpV = new THREE.Vector3(node.x, node.y, node.z)
				const scene = document.querySelector('a-scene')
				const canvas = scene.canvas
				const camera = scene.camera
				// get the normalized screen coordinate of node position
				tmpV.project(camera)
				// convert the normalized position to CSS coordinates
				const x = (tmpV.x * 0.5 + 0.5) * canvas.clientWidth
				const y = (tmpV.y * -0.5 + 0.5) * canvas.clientHeight
				// move the elem to that position
				labelEl.style.transform = `translate(-50%, -50%) translate(${x}px,${y}px)`
			}
			function showLabel2(node) {
				//				console.log(node)
				let oldTooltip = document.querySelector('#tooltip')
				if (oldTooltip) oldTooltip.remove()
				if (node === null) return
				//				console.log('node pos', node.x, node.y, node.z)
				//				let cp = document.querySelector('[camera]').getAttribute('position')
				//				console.log('camera', cp.x, cp.y, cp.z)
				let tooltip = document.createElement('a-entity')
				tooltip.id = 'tooltip'
				tooltip.setAttribute('text', {
					value: node.id,
					color: 'lightgrey',
					width: 4,
					anchor: 'center',
					align: 'center',
				})
				tooltip.setAttribute('scale', {x: 20, y: 20, z: 20})
				document.querySelector('a-scene').appendChild(tooltip)
				//				scene.appendChild(tooltip)
				tooltip.setAttribute('look-at', '[camera]')
				//				console.log('look at', tooltip.getAttribute('rotation'))
				//				tooltip.setAttribute('rotation', document.querySelector('[camera]').getAttribute('rotation'))
				//				console.log('camera rotation', document.querySelector('[camera]').getAttribute('rotation'))
				const sphereRadius = node.__threeObj.geometry.boundingSphere.radius
				const cameraPos = document.querySelector('[camera]').getAttribute('position')
				const labelPos = (d) => {
					//					if (Math.abs(node[d] - cameraPos[d]) < sphereRadius) return null
					if (node[d] > cameraPos[d]) return node[d] - sphereRadius
					return node[d] + sphereRadius
				}
				let tooltipPos = new THREE.Vector3(labelPos('x'), labelPos('y'), labelPos('z'))
				//				console.log('tooltip', tooltipPos.x, tooltipPos.y, tooltipPos.z)
				if (tooltipPos.x == null || tooltipPos.y == null || tooltipPos.z == null) /* inside node */ return
				tooltip.setAttribute('position', tooltipPos)
			}
		</script>
	</body>
</html>
